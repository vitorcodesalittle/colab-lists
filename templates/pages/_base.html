{{ block "base" . }}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>{{ .Title }}</title>
    <meta name="description" content="{{ .Description }}">
    <link href="/output.css" rel="stylesheet">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kolker+Brush&display=swap" rel="stylesheet">

    <link href="https://fonts.googleapis.com/css2?family=Gowun+Batang:wght@400;700&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/htmx.org@2.0.2"
        integrity="sha384-Y7hw+L/jvKeWIRRkqWYfPcvVxHzVzn5REgzbawhxAuQGwX1XWe70vji+VSeHOThJ"
        crossorigin="anonymous"></script>
    <script src="https://unpkg.com/htmx-ext-ws@2.0.1/ws.js"></script>
    <script>
        htmx.config.allowNestedOobSwaps = false
    </script>

    <script>
        document.querySelectorAll('time').forEach($e => {
            console.log("Hey, found a time element", $e);
            $e.innerHTML = date.toLocaleDateString();
        });
    </script>

    <script src="//unpkg.com/alpinejs" defer></script>
    <script>
        var _hrWebsSocket;
        const createWebSocket = () => {
            _hrWebsSocket = new WebSocket("ws://localhost:8080/ws/hot-reload");
            _hrWebsSocket.onmessage = function (event) {
                if (event.type === 'message') {
                    const serverRun = JSON.parse(event.data)
                    //console.log(`[HotReload]: Got ${serverRun.serverRunId}`)
                    if (_localServerRun?.serverRunId === undefined) {
                        _localServerRun = serverRun
                        _localServerRunStr = JSON.stringify(serverRun)
                    } else if (_localServerRun?.serverRunId !== serverRun.serverRunId) {
                        //console.log("[HotReload]: Server run id changed. reloading!...")
                        window.location.reload();
                    }
                }
            }
        }
        createWebSocket()
        var _hrChanged = false
        var _localServerRun = {};
        var _localServerRunStr = "{}"
        //console.log(`[HotReload]: Starting...`)
        setInterval(() => {
            if (_hrWebsSocket.readyState === WebSocket.OPEN) _hrWebsSocket.send(_localServerRunStr)
            else if (_hrWebsSocket.readyState === WebSocket.CLOSED) {
                //console.log(`[HotReload]: Connection closed, trying to reconnect....`)
                createWebSocket()
            }
        }, 500)
    </script>

    {{ .ExtraHead }}
</head>

<body class="group-hover/menu:bg-neutral-400 group-hover/menu:p-10">
    {{ .Body }}
</body>

</html>
{{ end }}

{{ define "authnav" }}
<div class=" bg-brand-800 flex flex-row px-2 py-2 w-full text-neutral-100 shadow-md items-center">
    <div class="group/menu z-50 flex flex-col flex-grow justify-center items-start">
        <div class="cursor-pointer border-brand-300 h-8 w-8 flex items-center justify-center my-auto">
            <span class="i-mdi-menu border text-xl hover:text-2xl m-auto" </span>
        </div>
        <div
            class="group-hover/menu:visible absolute invisible flex flex-row flex-grow justify-start space-x-2 -top-4 group-hover/menu:-left-4 -left-96 transition-all duration-500">
            <div
                class="bg-neutral-100 rounded shadow-2xl z-50 text-brand-800 flex flex-col w-72 h-screen p-4 pl-8 space-y-2">
                <a href="/communities"
                    class="cursor-pointer border-transparent border hover:border-b-brand-500 transition">Communities</a>
                <a href="/lists"
                    class="cursor-pointer border-transparent border hover:border-b-brand-500 transition">Lists</a>
                <a href="/logout"
                    class="mt-auto cursor-pointer border-transparent border hover:border-b-brand-500 transition">Logout</a>
            </div>
        </div>
    </div>
    <div class="flex flex-row items-center justify-center flex-grow">
        <div class="absolute">
            <a href="/" class="cursor-pointer text-2xl font-bold">
                <h2 class="callout-font cursor-pointer hover:text-5xl transition-all">
                    market lists
                </h2>
            </a>
        </div>
    </div>
    <div class="flex flex-grow">
    </div>
</div>
{{ end }}


{{ define "useruicard" }}
<div class="flex flex-row space-x-2 items-center">
    <img src="{{ .AvatarUrl }}" alt="{{ .Username }}" class="w-8 h-8 rounded-full" />
    <span class="text-nowrap">{{ .Username }} {{ if .Online -}}
        (online)
        {{- end }}</span>
    <input ws-send hx-vals='{"userId": {{ .Id }}, "actionType": 3 }' type="color" id="color-{{.Id}}" name="color"
        value="{{ .Color }}" />
</div>
{{ end }}

{{ define "usercard" }}
<div class="flex flex-row space-x-2 items-center">
    <img src="{{ .AvatarUrl }}" alt="{{ .Username }}" class="w-8 h-8 rounded-full" />
    <span class="text-nowrap">{{ .Username }} {{ if .Online -}}
        (online)
        {{- end }}</span>
</div>
{{ end }}


{{ define "selectuser" }}

<div
    x-data="{ searchResult: [], value: [], async fetchResults (event) { const users = await fetch('/api/users?q='+event.target.value); this.searchResult = await users.json(); }, toggleUserFromValue (user) { const userIds = this.value.map(user => user.id); const index = userIds.indexOf(user.id); if (index === -1) this.value.push(user); else this.value = this.value.filter(user2 => user2.id !== user.id); console.log(this.value)  }}">

    <p x-text="'Total result ' + searchResult.length "></p>
    <input id="search-user" type="text" placeholder="Search for a user"
        class="border border-neutral-300 rounded p-2 w-full" @input.debounce="fetchResults" />
    <div class="mt-2">
        Selected:
        <template x-for="user in value" :key="user.id">
            <div>
                <div x-text="user.username"></div>
                <input class="hidden" name="userId" :value="user.id" />
            </div>
        </template>
    </div>
    <div class="mt-2">
        <template x-for="user in searchResult" :key="user.id">
            <div :class="'cursor-pointer flex flex-row space-x-2 items-center p-2 rounded ' + (value.map(user => user.id).includes(user.id) ? 'bg-neutral-200' : '')"
                @click="toggleUserFromValue(user)">
                <img :src="user.avatarUrl" x-bind:alt="user.username" class="w-8 h-8 rounded-full" />
                <span x-text="user.username" class="text-nowrap"></span>
            </div>
        </template>
    </div>
</div>

{{ end }}
